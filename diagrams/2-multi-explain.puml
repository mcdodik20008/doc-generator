@startuml
title Multi-stage Explanation (Coder â†’ Instruct â†’ Speaker)

participant "ExplainController" as C
participant "ContextBuilder" as CTX
database "DB\n(node, chunk, profiles)" as DB
participant "LLM:Coder" as COD
participant "LLM:Instruct" as INS
participant "LLM:Speaker" as SPK
participant "QualityGate\n(lint+facts)" as QG

C -> CTX : loadNode(id)
CTX -> DB : SELECT node, chunks, neighbors
DB --> CTX : NodeBundle
CTX --> C : Context(code, relations, examples)

alt no cached 'coder'
  C -> COD : generate(coder_prompt(Context))
  COD --> C : coder_md
  C -> QG : validate(coder_md)
  QG --> C : ok/needs_fix
  C -> DB : UPSERT profile 'coder'
end

alt no cached 'instruct' or stale
  C -> INS : generate(instruct_prompt(Context, coder_md))
  INS --> C : instruct_md (usage, pitfalls, examples)
  C -> QG : validate(instruct_md)
  QG --> C : ok/needs_fix
  C -> DB : UPSERT profile 'instruct'
end

alt need 'speaker' for human-readable
  C -> SPK : generate(speaker_prompt(coder_md, instruct_md))
  SPK --> C : speaker_md (story-like, concise)
  C -> QG : validate(speaker_md)
  QG --> C : ok/needs_fix
  C -> DB : UPSERT profile 'speaker'
end

C --> C : return Profiles{coder,instruct,speaker}
@enduml
