@startuml
title Code Indexing & Enrichment Pipeline

actor Dev as D
participant "Repo Scanner\n(git/dir)" as RS
participant "Parser\n(Kotlin/Java/SQL PSI)" as P
participant "GraphBuilder\n(Node/Edge)" as GB
database "Postgres\n(doc_generator)" as DB
participant "Chunker\n(code-aware)" as CH
participant "Embedder\n(vec-1024)" as EM
participant "ExplainerOrchestrator\n(coder→instruct→speaker)" as XO

D -> RS : start(project, appKey)
RS -> P : parse(files)
activate P
P --> RS : PSI (types, methods, ranges)
deactivate P

RS -> GB : upsertNodesEdges(PSI)
activate GB
GB -> DB : INSERT/UPSERT node, edge
GB --> RS : nodeIds
deactivate GB

RS -> CH : chunk(file, ranges, strategy=code-aware)
activate CH
CH -> DB : INSERT chunk(node_id, lang, text, meta)
CH --> RS : chunkIds
deactivate CH

RS -> EM : embed(chunkIds)
activate EM
EM -> DB : UPDATE chunk SET embedding=vector
deactivate EM

RS -> XO : enrich(nodeIds, chunkIds)
activate XO
XO -> XO : stage1: coder (структура/сигнатуры)\nstage2: instruct (как использовать)\nstage3: speaker (человечный пересказ)
XO -> DB : UPSERT node_doc_profiles\n{profile:'coder'|'instruct'|'speaker', quality, provenance}
XO --> RS : EnrichReport
deactivate XO

RS --> D : IndexReport{nodes,edges,chunks,profiles}
@enduml
