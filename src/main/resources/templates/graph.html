<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <title>Code Graph Explorer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
    <style>
        :root {
            --bg: #1e1e2e;
            --surface: #282840;
            --surface2: #313150;
            --border: #3e3e5e;
            --text: #cdd6f4;
            --text-muted: #8888aa;
            --accent: #89b4fa;
            --accent-dim: #45577d;
            --green: #a6e3a1;
            --red: #f38ba8;
            --yellow: #f9e2af;
            --peach: #fab387;
            --pink: #f5c2e7;
            --teal: #94e2d5;
            --lavender: #b4befe;
            --mauve: #cba6f7;
            --panel-w: 440px;
            --panel-collapsed: 0px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            height: 100%;
            font-family: 'Segoe UI', system-ui, sans-serif;
            font-size: 15px;
            background: var(--bg);
            color: var(--text);
        }

        #app {
            display: grid;
            grid-template-columns: 1fr var(--panel-w);
            height: 100%;
            transition: grid-template-columns .3s ease;
        }
        #app.panel-hidden { grid-template-columns: 1fr var(--panel-collapsed); }

        /* ======== Canvas ======== */
        #cy-wrap { position: relative; overflow: hidden; }
        #cy { width: 100%; height: 100%; }

        #stats-bar {
            position: absolute; top: 12px; left: 12px;
            background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
            padding: 8px 16px; font-size: 14px; color: var(--text-muted);
            display: flex; gap: 20px; z-index: 10;
        }
        #stats-bar span { color: var(--accent); font-weight: 600; }

        #toolbar {
            position: absolute; bottom: 14px; left: 14px;
            display: flex; gap: 6px; z-index: 10;
        }
        #toolbar button {
            background: var(--surface); border: 1px solid var(--border); border-radius: 6px;
            color: var(--text); padding: 8px 14px; cursor: pointer; font-size: 15px;
        }
        #toolbar button:hover { background: var(--surface2); }

        /* Panel toggle button — always visible on canvas */
        #panelToggle {
            position: absolute; top: 12px; right: 12px; z-index: 10;
            background: var(--surface); border: 1px solid var(--border); border-radius: 6px;
            color: var(--text); padding: 8px 12px; cursor: pointer; font-size: 18px;
            line-height: 1; transition: transform .3s;
        }
        #panelToggle:hover { background: var(--surface2); }
        #app.panel-hidden #panelToggle { transform: rotate(180deg); }

        /* ======== Side Panel ======== */
        #panel {
            background: var(--surface); border-left: 1px solid var(--border);
            display: flex; flex-direction: column; overflow: hidden;
            transition: opacity .3s, visibility .3s;
        }
        #app.panel-hidden #panel { opacity: 0; visibility: hidden; pointer-events: none; }

        /* Scrollable panel body */
        #panel-body {
            flex: 1; overflow-y: auto;
        }
        #panel-body::-webkit-scrollbar { width: 6px; }
        #panel-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* ---- Panel sections (collapsible) ---- */
        .panel-section { border-bottom: 1px solid var(--border); }
        .section-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 16px; cursor: pointer; user-select: none;
        }
        .section-header:hover { background: var(--surface2); }
        .section-header h3 {
            font-size: 13px; text-transform: uppercase; letter-spacing: 1px;
            color: var(--text-muted); margin: 0; font-weight: 600;
        }
        .section-arrow {
            font-size: 12px; color: var(--text-muted); transition: transform .2s;
        }
        .panel-section.collapsed .section-arrow { transform: rotate(-90deg); }
        .section-body { padding: 4px 16px 14px; }
        .panel-section.collapsed .section-body { display: none; }

        /* ---- Form elements ---- */
        label {
            display: block; font-size: 13px; color: var(--text-muted);
            margin-bottom: 3px; margin-top: 6px;
        }
        label:first-child { margin-top: 0; }
        input[type=number], input[type=text] {
            width: 100%; padding: 8px 10px; font-size: 15px;
            background: var(--bg); color: var(--text);
            border: 1px solid var(--border); border-radius: 6px;
            margin-bottom: 4px;
        }
        input:focus { outline: none; border-color: var(--accent); }

        .row { display: flex; gap: 10px; }
        .row > * { flex: 1; }

        .checkbox-row {
            display: flex; align-items: center; gap: 8px;
            margin: 8px 0; font-size: 14px;
        }
        .checkbox-row input[type=checkbox] {
            accent-color: var(--accent); width: 18px; height: 18px;
        }

        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
            width: 100%; padding: 10px; font-size: 15px; font-weight: 600;
            border: none; border-radius: 6px; cursor: pointer;
            transition: background .15s; margin-top: 6px;
        }
        .btn-primary { background: var(--accent); color: var(--bg); }
        .btn-primary:hover { background: #a0c4ff; }
        .btn-primary:disabled { opacity: .5; cursor: not-allowed; }

        select {
            width: 100%; padding: 8px 10px; font-size: 15px;
            background: var(--bg); color: var(--text);
            border: 1px solid var(--border); border-radius: 6px;
            margin-bottom: 4px;
        }
        select:focus { outline: none; border-color: var(--accent); }

        /* ---- Filter chips ---- */
        .chip-container {
            display: flex; flex-wrap: wrap; gap: 5px; margin: 4px 0;
        }
        .chip {
            font-size: 12px; padding: 4px 10px; border-radius: 12px;
            border: 1px solid var(--border); cursor: pointer; user-select: none;
            background: transparent; color: var(--text-muted);
            transition: all .15s; white-space: nowrap;
        }
        .chip.active {
            border-color: var(--accent); color: var(--text);
            background: var(--accent-dim);
        }
        .chip:hover { border-color: var(--accent); }

        .chip-actions {
            display: flex; gap: 8px; margin-bottom: 6px; font-size: 12px;
        }
        .chip-actions a {
            color: var(--accent); cursor: pointer; text-decoration: none;
        }
        .chip-actions a:hover { text-decoration: underline; }

        /* ---- Legend ---- */
        .legend { display: flex; flex-wrap: wrap; gap: 6px 14px; }
        .legend-item {
            display: flex; align-items: center; gap: 5px;
            font-size: 13px; color: var(--text-muted);
        }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
        .legend-line { width: 20px; height: 3px; border-radius: 2px; flex-shrink: 0; }

        /* ---- Details ---- */
        .detail-placeholder {
            color: var(--text-muted); font-size: 15px;
            text-align: center; padding: 40px 16px;
        }
        .detail-placeholder small { font-size: 13px; color: var(--text-muted); }

        .detail-header { margin-bottom: 14px; padding: 0 16px; }
        .detail-header h2 { font-size: 17px; color: var(--text); word-break: break-all; }
        .detail-meta { font-size: 14px; color: var(--text-muted); margin-top: 4px; }

        .detail-block { margin-bottom: 16px; padding: 0 16px; }
        .detail-block h4 {
            font-size: 12px; text-transform: uppercase; letter-spacing: .5px;
            color: var(--text-muted); margin-bottom: 6px;
        }
        .detail-block pre {
            background: var(--bg); padding: 10px 12px; border-radius: 6px; font-size: 13px;
            overflow-x: auto; white-space: pre-wrap; word-break: break-word;
            max-height: 350px; overflow-y: auto; color: var(--text);
            line-height: 1.5;
        }

        .relation-list { list-style: none; font-size: 14px; }
        .relation-list li {
            padding: 5px 0; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 8px;
        }
        .relation-kind {
            font-size: 11px; padding: 2px 7px; border-radius: 4px;
            background: var(--accent-dim); color: var(--accent);
            white-space: nowrap;
        }
        .relation-link {
            color: var(--accent); cursor: pointer; text-decoration: underline;
        }

        /* ---- Loading / Toast ---- */
        .loading-overlay {
            position: absolute; inset: 0; background: rgba(30,30,46,.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 100; font-size: 16px; color: var(--text-muted);
        }
        .spinner {
            width: 28px; height: 28px; border: 3px solid var(--border);
            border-top-color: var(--accent); border-radius: 50%;
            animation: spin .8s linear infinite; margin-right: 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .toast {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
            background: var(--red); color: var(--bg); padding: 12px 24px;
            border-radius: 8px; font-size: 14px; z-index: 200;
            max-width: 600px; text-align: center;
            animation: fadeInOut 4s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(10px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* ---- Search ---- */
        .search-wrap { position: relative; }
        .search-wrap input { padding-right: 32px; }
        .search-clear {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            background: none; border: none; color: var(--text-muted); cursor: pointer;
            font-size: 18px; padding: 2px;
        }
    </style>
</head>
<body>
<div id="app">
    <!-- ===== Canvas ===== -->
    <div id="cy-wrap">
        <div id="cy"></div>
        <div id="stats-bar">
            Nodes: <span id="stat-nodes">0</span>
            Edges: <span id="stat-edges">0</span>
            Selected: <span id="stat-selected">-</span>
        </div>
        <div id="toolbar">
            <button onclick="cy.fit(undefined,30)" title="Fit to screen">Fit</button>
            <button onclick="cy.zoom(cy.zoom()*1.3);cy.center()" title="Zoom in">+</button>
            <button onclick="cy.zoom(cy.zoom()/1.3);cy.center()" title="Zoom out">&minus;</button>
            <button onclick="relayout()" title="Re-run layout">Layout</button>
        </div>
        <button id="panelToggle" onclick="togglePanel()" title="Toggle panel">&#x25C0;</button>
    </div>

    <!-- ===== Side panel ===== -->
    <div id="panel">
        <div id="panel-body">

            <!-- QUERY -->
            <div class="panel-section" id="sec-query">
                <div class="section-header" onclick="toggleSection('sec-query')">
                    <h3>Graph Query</h3>
                    <span class="section-arrow">&#9660;</span>
                </div>
                <div class="section-body">
                    <div class="row">
                        <div>
                            <label>Application ID</label>
                            <input id="appId" type="number" value="14"/>
                        </div>
                        <div>
                            <label>Limit</label>
                            <input id="limit" type="number" value="500"/>
                        </div>
                    </div>

                    <label>Layout</label>
                    <select id="layoutSelect">
                        <option value="cose">COSE (force-directed)</option>
                        <option value="breadthfirst">Breadthfirst (hierarchical)</option>
                        <option value="circle">Circle</option>
                        <option value="concentric">Concentric</option>
                        <option value="grid">Grid</option>
                    </select>

                    <button class="btn btn-primary" id="loadBtn" onclick="loadGraph()">Load Graph</button>
                </div>
            </div>

            <!-- NODE KINDS -->
            <div class="panel-section" id="sec-nodekinds">
                <div class="section-header" onclick="toggleSection('sec-nodekinds')">
                    <h3>Node Kinds</h3>
                    <span class="section-arrow">&#9660;</span>
                </div>
                <div class="section-body">
                    <div class="chip-actions">
                        <a onclick="chipSelectAll('node')">Select all</a>
                        <a onclick="chipSelectNone('node')">Clear</a>
                    </div>
                    <div id="nodeKindChips" class="chip-container"></div>
                </div>
            </div>

            <!-- EDGE KINDS -->
            <div class="panel-section" id="sec-edgekinds">
                <div class="section-header" onclick="toggleSection('sec-edgekinds')">
                    <h3>Edge Kinds (visible)</h3>
                    <span class="section-arrow">&#9660;</span>
                </div>
                <div class="section-body">
                    <div class="chip-actions">
                        <a onclick="chipSelectAll('edge')">Select all</a>
                        <a onclick="chipSelectNone('edge')">Clear</a>
                    </div>
                    <div id="edgeKindChips" class="chip-container"></div>
                    <div class="checkbox-row" style="margin-top:8px">
                        <input type="checkbox" id="withRelations"/>
                        <label for="withRelations" style="margin:0">Fetch ALL edge types from server</label>
                    </div>
                </div>
            </div>

            <!-- SEARCH -->
            <div class="panel-section" id="sec-search">
                <div class="section-header" onclick="toggleSection('sec-search')">
                    <h3>Search</h3>
                    <span class="section-arrow">&#9660;</span>
                </div>
                <div class="section-body">
                    <div class="search-wrap">
                        <input id="searchInput" type="text" placeholder="Search nodes by name..." oninput="onSearch(this.value)"/>
                        <button class="search-clear" onclick="clearSearch()" title="Clear">&times;</button>
                    </div>
                </div>
            </div>

            <!-- LEGEND -->
            <div class="panel-section collapsed" id="sec-legend">
                <div class="section-header" onclick="toggleSection('sec-legend')">
                    <h3>Legend</h3>
                    <span class="section-arrow">&#9660;</span>
                </div>
                <div class="section-body">
                    <label style="margin-top:0">Nodes</label>
                    <div id="nodeLegend" class="legend"></div>
                    <label>Edges</label>
                    <div id="edgeLegend" class="legend"></div>
                </div>
            </div>

            <!-- DETAILS -->
            <div class="panel-section" id="sec-details">
                <div class="section-header" onclick="toggleSection('sec-details')">
                    <h3>Node Details</h3>
                    <span class="section-arrow">&#9660;</span>
                </div>
                <div class="section-body" style="padding-left:0;padding-right:0">
                    <div id="details">
                        <div class="detail-placeholder">
                            Click a node to see details<br/>
                            <small>Double-click to expand neighbors</small>
                        </div>
                    </div>
                </div>
            </div>

        </div><!-- /panel-body -->
    </div>
</div>

<script>
// ============================================================
//  CONFIG
// ============================================================
const NODE_KINDS = [
    'CLASS','INTERFACE','ENUM','RECORD','METHOD','FIELD','EXCEPTION','TEST','MAPPER',
    'REPO','MODULE','PACKAGE',
    'SERVICE','ENDPOINT','CLIENT','TOPIC','JOB',
    'DB_TABLE','DB_VIEW','DB_QUERY','SCHEMA','CONFIG','MIGRATION','ANNOTATION'
];

const EDGE_KINDS = [
    'CALLS','CALLS_CODE','CONTAINS','DEPENDS_ON',
    'IMPLEMENTS','INHERITS','EXTENDS','OVERRIDES','ANNOTATED_WITH',
    'THROWS','LOCKS',
    'CALLS_HTTP','CALLS_GRPC','CALLS_CAMEL',
    'PRODUCES','CONSUMES',
    'QUERIES','READS','WRITES',
    'CONTRACTS_WITH','CONFIGURES',
    'CIRCUIT_BREAKER_TO','RETRIES_TO','TIMEOUTS_TO'
];

const NODE_COLORS = {
    CLASS:'#fab387', INTERFACE:'#cba6f7', ENUM:'#f9e2af', RECORD:'#f2cdcd',
    METHOD:'#a6e3a1', FIELD:'#74c7ec', EXCEPTION:'#f38ba8', TEST:'#94e2d5',
    MAPPER:'#89dceb', REPO:'#585b70', MODULE:'#6c7086', PACKAGE:'#7f849c',
    SERVICE:'#89b4fa', ENDPOINT:'#b4befe', CLIENT:'#f5c2e7', TOPIC:'#eba0ac',
    JOB:'#a6adc8', DB_TABLE:'#f9e2af', DB_VIEW:'#f5e0dc', DB_QUERY:'#fab387',
    SCHEMA:'#cba6f7', CONFIG:'#9399b2', MIGRATION:'#bac2de', ANNOTATION:'#f5c2e7',
};

const NODE_SHAPES = {
    CLASS:'round-rectangle', INTERFACE:'diamond', ENUM:'pentagon',
    METHOD:'ellipse', SERVICE:'hexagon', ENDPOINT:'star',
    CLIENT:'vee', TOPIC:'tag', DB_TABLE:'barrel',
};

const EDGE_COLORS = {
    CALLS:'#a6e3a1', CALLS_CODE:'#a6e3a1', CONTAINS:'#585b70',
    DEPENDS_ON:'#f9e2af', IMPLEMENTS:'#cba6f7', INHERITS:'#b4befe',
    EXTENDS:'#b4befe', OVERRIDES:'#89b4fa', ANNOTATED_WITH:'#f5c2e7',
    THROWS:'#f38ba8', CALLS_HTTP:'#89b4fa', CALLS_GRPC:'#94e2d5',
    CALLS_CAMEL:'#fab387', PRODUCES:'#fab387', CONSUMES:'#eba0ac',
    QUERIES:'#f9e2af', READS:'#74c7ec', WRITES:'#f38ba8', LOCKS:'#f38ba8',
    CONTRACTS_WITH:'#cba6f7', CONFIGURES:'#9399b2',
    CIRCUIT_BREAKER_TO:'#f38ba8', RETRIES_TO:'#f9e2af', TIMEOUTS_TO:'#fab387',
};

const DEFAULT_NODE_COLOR = '#7f849c';
const DEFAULT_EDGE_COLOR = '#585b70';

// ---- State ----
let activeNodeKinds = new Set(['CLASS', 'METHOD']);
let activeEdgeKinds = new Set(EDGE_KINDS);     // all visible by default
let currentLayoutName = 'cose';
let cy;

// ============================================================
//  PANEL UI
// ============================================================
function togglePanel() {
    document.getElementById('app').classList.toggle('panel-hidden');
    // let cytoscape recalculate after animation
    setTimeout(() => cy.resize(), 350);
}

function toggleSection(sectionId) {
    document.getElementById(sectionId).classList.toggle('collapsed');
}

// ============================================================
//  CHIP BUILDERS
// ============================================================
function buildChips(containerId, items, activeSet, colorMap, type) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    for (const item of items) {
        const chip = document.createElement('span');
        chip.className = 'chip' + (activeSet.has(item) ? ' active' : '');
        chip.textContent = item;
        chip.dataset.kind = item;
        chip.dataset.type = type;
        if (activeSet.has(item) && colorMap[item]) {
            chip.style.borderColor = colorMap[item];
        }
        chip.onclick = () => {
            if (activeSet.has(item)) {
                activeSet.delete(item);
                chip.classList.remove('active');
                chip.style.borderColor = '';
            } else {
                activeSet.add(item);
                chip.classList.add('active');
                chip.style.borderColor = colorMap[item] || '';
            }
            if (type === 'edge') applyEdgeFilter();
        };
        container.appendChild(chip);
    }
}

function chipSelectAll(type) {
    if (type === 'node') {
        NODE_KINDS.forEach(k => activeNodeKinds.add(k));
        buildChips('nodeKindChips', NODE_KINDS, activeNodeKinds, NODE_COLORS, 'node');
    } else {
        EDGE_KINDS.forEach(k => activeEdgeKinds.add(k));
        buildChips('edgeKindChips', EDGE_KINDS, activeEdgeKinds, EDGE_COLORS, 'edge');
        applyEdgeFilter();
    }
}

function chipSelectNone(type) {
    if (type === 'node') {
        activeNodeKinds.clear();
        buildChips('nodeKindChips', NODE_KINDS, activeNodeKinds, NODE_COLORS, 'node');
    } else {
        activeEdgeKinds.clear();
        buildChips('edgeKindChips', EDGE_KINDS, activeEdgeKinds, EDGE_COLORS, 'edge');
        applyEdgeFilter();
    }
}

// Show/hide edges based on activeEdgeKinds (client-side filter, no reload)
function applyEdgeFilter() {
    if (!cy) return;
    cy.edges().forEach(e => {
        if (activeEdgeKinds.has(e.data('kind'))) {
            e.style('display', 'element');
        } else {
            e.style('display', 'none');
        }
    });
    updateStats();
}

// ============================================================
//  CYTOSCAPE INIT
// ============================================================
function buildCyStyles() {
    const styles = [
        {
            selector: 'node',
            style: {
                'label': 'data(label)',
                'font-size': 11,
                'font-family': 'Segoe UI, system-ui, sans-serif',
                'color': '#cdd6f4',
                'text-outline-color': '#1e1e2e',
                'text-outline-width': 2,
                'text-valign': 'bottom',
                'text-margin-y': 5,
                'background-color': DEFAULT_NODE_COLOR,
                'width': 32,
                'height': 32,
                'border-width': 0,
                'overlay-padding': 5,
            }
        },
        {
            selector: 'edge',
            style: {
                'line-color': DEFAULT_EDGE_COLOR,
                'width': 2,
                'curve-style': 'bezier',
                'target-arrow-shape': 'triangle',
                'target-arrow-color': DEFAULT_EDGE_COLOR,
                'arrow-scale': 0.9,
                'opacity': 0.6,
            }
        },
        {
            selector: ':selected',
            style: { 'border-width': 3, 'border-color': '#89b4fa', 'z-index': 10 }
        },
        {
            selector: '.highlighted',
            style: { 'border-width': 3, 'border-color': '#f9e2af' }
        },
        {
            selector: '.dimmed',
            style: { 'opacity': 0.12 }
        },
        {
            selector: '.expanded-source',
            style: { 'border-width': 4, 'border-color': '#f5c2e7', 'border-style': 'double' }
        }
    ];

    for (const [kind, color] of Object.entries(NODE_COLORS)) {
        styles.push({
            selector: 'node[kind = "' + kind + '"]',
            style: { 'background-color': color, 'shape': NODE_SHAPES[kind] || 'ellipse' }
        });
    }
    for (const [kind, color] of Object.entries(EDGE_COLORS)) {
        styles.push({
            selector: 'edge[kind = "' + kind + '"]',
            style: { 'line-color': color, 'target-arrow-color': color }
        });
    }
    return styles;
}

function initCy() {
    cy = cytoscape({
        container: document.getElementById('cy'),
        elements: [],
        style: buildCyStyles(),
        layout: { name: 'preset' },
        minZoom: 0.05,
        maxZoom: 5,
        wheelSensitivity: 0.3,
    });

    cy.on('tap', 'node', evt => showNodeDetails(evt.target));
    cy.on('dbltap', 'node', evt => expandNode(evt.target.id()));
    cy.on('tap', evt => {
        if (evt.target === cy) { clearHighlights(); updateStats(); }
    });
    cy.on('select unselect', () => updateStats());

    // Del / Backspace — remove selected nodes visually
    document.addEventListener('keydown', evt => {
        if (evt.key === 'Delete' || evt.key === 'Backspace') {
            // don't fire when typing in an input/select
            const tag = (evt.target.tagName || '').toLowerCase();
            if (tag === 'input' || tag === 'textarea' || tag === 'select') return;

            const selected = cy.$(':selected');
            if (selected.length === 0) return;

            evt.preventDefault();
            // remove connected edges first, then nodes
            selected.connectedEdges().remove();
            selected.remove();
            updateStats();
            updateLegends();
        }
    });
}

// ============================================================
//  API
// ============================================================
async function fetchGraph(appId, kinds, limit, withRelations) {
    const params = new URLSearchParams();
    params.set('applicationId', String(appId));
    params.set('limit', String(limit));
    params.set('withRelations', String(withRelations));
    kinds.forEach(kind => params.append('kinds', kind));
    const url = '/api/graph/chunks?' + params.toString();
    console.log('[graph] GET', url);
    const res = await fetch(url);
    if (!res.ok) {
        const text = await res.text().catch(() => '');
        throw new Error('HTTP ' + res.status + ': ' + text.substring(0, 300));
    }
    const json = await res.json();
    console.log('[graph] Response:', json);
    if (!json || !Array.isArray(json.nodes)) {
        throw new Error('Unexpected response: ' + JSON.stringify(json).substring(0, 300));
    }
    return json;
}

async function fetchExpand(nodeId, limit) {
    const params = new URLSearchParams();
    params.set('nodeId', nodeId);
    params.set('limit', String(limit));
    const res = await fetch('/api/graph/chunks/expand?' + params.toString());
    if (!res.ok) {
        const text = await res.text().catch(() => '');
        throw new Error('HTTP ' + res.status + ': ' + text.substring(0, 300));
    }
    const json = await res.json();
    if (!json || !Array.isArray(json.nodes)) {
        throw new Error('Unexpected expand response: ' + JSON.stringify(json).substring(0, 300));
    }
    return json;
}

async function fetchDetails(id) {
    const res = await fetch('/api/chunks/' + encodeURIComponent(id));
    if (!res.ok) {
        const text = await res.text().catch(() => '');
        throw new Error('HTTP ' + res.status + ': ' + text.substring(0, 300));
    }
    return await res.json();
}

// ============================================================
//  GRAPH OPS
// ============================================================
function toCyElements(graph) {
    if (!graph) return { nodes: [], edges: [] };
    const graphNodes = graph.nodes || [];
    const graphEdges = graph.edges || [];

    const nodeSet = new Set();
    const nodes = [];
    for (const n of graphNodes) {
        if (nodeSet.has(n.id)) continue;
        nodeSet.add(n.id);
        nodes.push({ data: {
            id: n.id, label: n.label, kind: n.kind,
            group: n.group || '', size: n.size || 20,
        }});
    }

    const edgeSet = new Set();
    const edges = [];
    for (const e of graphEdges) {
        if (edgeSet.has(e.id)) continue;
        if (!nodeSet.has(e.source) || !nodeSet.has(e.target)) continue;
        edgeSet.add(e.id);
        edges.push({ data: {
            id: e.id, source: e.source, target: e.target,
            kind: e.kind, weight: e.weight || 1,
        }});
    }
    return { nodes, edges };
}

function runLayout(name) {
    currentLayoutName = name || currentLayoutName;
    const opts = { name: currentLayoutName, animate: true, animationDuration: 600 };

    if (currentLayoutName === 'cose') {
        Object.assign(opts, {
            nodeRepulsion: function() { return 8000; },
            idealEdgeLength: function() { return 80; },
            gravity: 0.3, numIter: 500, animate: 'end',
        });
    } else if (currentLayoutName === 'breadthfirst') {
        Object.assign(opts, { spacingFactor: 1.2, directed: true });
    } else if (currentLayoutName === 'concentric') {
        Object.assign(opts, {
            concentric: function(n) { return n.connectedEdges().length; },
            levelWidth: function() { return 3; },
        });
    }
    cy.layout(opts).run();
}

function relayout() {
    runLayout(document.getElementById('layoutSelect').value);
}

// ---- Loading / Toast ----
function showLoading(text) {
    let el = document.getElementById('loadingOverlay');
    if (!el) {
        el = document.createElement('div');
        el.id = 'loadingOverlay';
        el.className = 'loading-overlay';
        document.getElementById('cy-wrap').appendChild(el);
    }
    el.innerHTML = '<div class="spinner"></div>' + escapeHtml(text || 'Loading...');
    el.style.display = 'flex';
}
function hideLoading() {
    const el = document.getElementById('loadingOverlay');
    if (el) el.style.display = 'none';
}
function showToast(msg) {
    const el = document.createElement('div');
    el.className = 'toast';
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 4500);
}

// ---- Load ----
async function loadGraph() {
    const appId = Number(document.getElementById('appId').value);
    const limit = Number(document.getElementById('limit').value) || 500;
    const withRelations = document.getElementById('withRelations').checked;
    const kinds = [...activeNodeKinds];

    if (!appId || appId <= 0) { showToast('Application ID must be positive'); return; }
    if (kinds.length === 0) { showToast('Select at least one Node Kind'); return; }

    const btn = document.getElementById('loadBtn');
    btn.disabled = true;
    showLoading('Loading graph data...');

    try {
        const g = await fetchGraph(appId, kinds, limit, withRelations);
        const { nodes, edges } = toCyElements(g);

        cy.elements().remove();
        cy.add(nodes);
        cy.add(edges);

        applyEdgeFilter();

        showLoading('Running layout...');
        runLayout(document.getElementById('layoutSelect').value);
        cy.fit(undefined, 30);

        updateStats();
        updateLegends();
    } catch (e) {
        console.error(e);
        showToast(String(e.message || e));
    } finally {
        btn.disabled = false;
        hideLoading();
    }
}

// ---- Expand ----
async function expandNode(nodeId) {
    showLoading('Expanding neighbors...');
    try {
        const g = await fetchExpand(nodeId, 50);
        const { nodes, edges } = toCyElements(g);

        const existingIds = new Set(cy.nodes().map(n => n.id()));
        const newNodes = nodes.filter(n => !existingIds.has(n.data.id));

        const existingEdgeIds = new Set(cy.edges().map(e => e.id()));
        const newEdges = edges.filter(e => !existingEdgeIds.has(e.data.id));

        if (newNodes.length === 0 && newEdges.length === 0) {
            showToast('No new neighbors found');
            return;
        }

        cy.add(newNodes);
        cy.add(newEdges);
        applyEdgeFilter();

        cy.getElementById(nodeId).addClass('expanded-source');
        newNodes.forEach(n => cy.getElementById(n.data.id).addClass('highlighted'));

        const newColl = cy.collection(newNodes.map(n => cy.getElementById(n.data.id)));
        newColl.layout({
            name: 'concentric',
            boundingBox: cy.getElementById(nodeId).boundingBox(),
            concentric: () => 1, levelWidth: () => 1,
            animate: true, animationDuration: 400,
        }).run();

        updateStats();
        updateLegends();
    } catch (e) {
        console.error(e);
        showToast('Expand failed: ' + (e.message || e));
    } finally {
        hideLoading();
    }
}

// ---- Details ----
async function showNodeDetails(cyNode) {
    // Auto-open details section if collapsed
    const sec = document.getElementById('sec-details');
    if (sec.classList.contains('collapsed')) sec.classList.remove('collapsed');

    const detailsEl = document.getElementById('details');
    detailsEl.innerHTML = '<div class="detail-placeholder"><div class="spinner" style="margin:0 auto 10px"></div>Loading...</div>';

    try {
        const d = await fetchDetails(cyNode.id());

        let html = '<div class="detail-header">';
        html += '<h2>' + escapeHtml(d.title || cyNode.data('label')) + '</h2>';
        html += '<div class="detail-meta">';
        if (d.node) {
            html += '<span style="color:' + (NODE_COLORS[d.node.kind] || DEFAULT_NODE_COLOR) + '">' + escapeHtml(d.node.kind) + '</span>';
            if (d.node.packageName) html += ' &bull; ' + escapeHtml(d.node.packageName);
        }
        if (d.embeddingSize != null) html += ' &bull; emb: ' + d.embeddingSize + 'd';
        html += '</div></div>';

        if (d.content) {
            html += '<div class="detail-block"><h4>Content</h4>';
            html += '<pre>' + escapeHtml(d.content) + '</pre></div>';
        }

        if (d.relations) {
            if (d.relations.outgoing && d.relations.outgoing.length > 0) {
                html += '<div class="detail-block"><h4>Outgoing (' + d.relations.outgoing.length + ')</h4>';
                html += '<ul class="relation-list">';
                for (const r of d.relations.outgoing) {
                    html += '<li><span class="relation-kind">' + escapeHtml(r.kind) + '</span>';
                    html += ' <span class="relation-link" onclick="focusNode(\'' + escapeHtml(r.otherNodeId) + '\')">' + escapeHtml(r.otherNodeId) + '</span></li>';
                }
                html += '</ul></div>';
            }
            if (d.relations.incoming && d.relations.incoming.length > 0) {
                html += '<div class="detail-block"><h4>Incoming (' + d.relations.incoming.length + ')</h4>';
                html += '<ul class="relation-list">';
                for (const r of d.relations.incoming) {
                    html += '<li><span class="relation-kind">' + escapeHtml(r.kind) + '</span>';
                    html += ' <span class="relation-link" onclick="focusNode(\'' + escapeHtml(r.otherNodeId) + '\')">' + escapeHtml(r.otherNodeId) + '</span></li>';
                }
                html += '</ul></div>';
            }
        }

        if (d.metadata && Object.keys(d.metadata).length > 0) {
            html += '<div class="detail-block"><h4>Metadata</h4>';
            html += '<pre>' + escapeHtml(JSON.stringify(d.metadata, null, 2)) + '</pre></div>';
        }

        detailsEl.innerHTML = html;
    } catch (e) {
        detailsEl.innerHTML = '<div class="detail-placeholder" style="color:var(--red)">' + escapeHtml(String(e.message || e)) + '</div>';
    }
}

function focusNode(nodeId) {
    const n = cy.getElementById(nodeId);
    if (n.length > 0) {
        cy.animate({ center: { eles: n }, zoom: 2 }, { duration: 400 });
        n.select();
        showNodeDetails(n);
    } else {
        showToast('Node ' + nodeId + ' not in graph. Try expanding.');
    }
}

// ---- Search ----
function onSearch(query) {
    clearHighlights();
    if (!query || query.length < 2) return;
    const q = query.toLowerCase();
    const matches = cy.nodes().filter(n => {
        const label = (n.data('label') || '').toLowerCase();
        const group = (n.data('group') || '').toLowerCase();
        return label.includes(q) || group.includes(q);
    });
    if (matches.length === 0) return;
    cy.elements().addClass('dimmed');
    matches.forEach(n => {
        n.removeClass('dimmed').addClass('highlighted');
        n.connectedEdges().removeClass('dimmed');
    });
    if (matches.length <= 10) {
        cy.animate({ fit: { eles: matches, padding: 50 } }, { duration: 400 });
    }
}
function clearSearch() {
    document.getElementById('searchInput').value = '';
    clearHighlights();
}
function clearHighlights() {
    cy.elements().removeClass('dimmed highlighted');
}

// ---- Stats ----
function updateStats() {
    document.getElementById('stat-nodes').textContent = cy.nodes().length;
    // Count only visible edges
    const visibleEdges = cy.edges().filter(e => e.style('display') !== 'none');
    document.getElementById('stat-edges').textContent = visibleEdges.length;
    const sel = cy.$(':selected');
    document.getElementById('stat-selected').textContent =
        sel.length > 0 ? (sel.data('label') || sel.id()) : '-';
}

// ---- Legends ----
function updateLegends() {
    const kindsInGraph = new Set();
    cy.nodes().forEach(n => kindsInGraph.add(n.data('kind')));
    const nodeLegend = document.getElementById('nodeLegend');
    nodeLegend.innerHTML = '';
    for (const kind of kindsInGraph) {
        const item = document.createElement('div');
        item.className = 'legend-item';
        item.innerHTML = '<div class="legend-dot" style="background:' + (NODE_COLORS[kind] || DEFAULT_NODE_COLOR) + '"></div>' + kind;
        nodeLegend.appendChild(item);
    }

    const edgeKindsInGraph = new Set();
    cy.edges().forEach(e => edgeKindsInGraph.add(e.data('kind')));
    const edgeLegend = document.getElementById('edgeLegend');
    edgeLegend.innerHTML = '';
    for (const kind of edgeKindsInGraph) {
        const item = document.createElement('div');
        item.className = 'legend-item';
        item.innerHTML = '<div class="legend-line" style="background:' + (EDGE_COLORS[kind] || DEFAULT_EDGE_COLOR) + '"></div>' + kind;
        edgeLegend.appendChild(item);
    }
}

// ---- Util ----
function escapeHtml(s) {
    if (!s) return '';
    return String(s).replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[c]));
}

// ============================================================
//  BOOTSTRAP
// ============================================================
(function bootstrap() {
    initCy();
    buildChips('nodeKindChips', NODE_KINDS, activeNodeKinds, NODE_COLORS, 'node');
    buildChips('edgeKindChips', EDGE_KINDS, activeEdgeKinds, EDGE_COLORS, 'edge');
    loadGraph().catch(e => {
        console.error('Initial load failed:', e);
        hideLoading();
    });
})();
</script>
</body>
</html>
